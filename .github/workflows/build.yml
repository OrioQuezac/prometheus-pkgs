name: build
run-name: Build Artifacts
on: push
jobs:
  build-artifacts:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository to the runner
        uses: actions/checkout@v4
      - name: Build Prometheus Artifacts
        run: sudo ./build.sh all
      - name: Copy nfpm confs
        run: sudo cp nfpm/* _build/
      - name: Archive Prometheus Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: prometheus-artifacts
          path: _build
  nfpm:
    runs-on: ubuntu-latest
    needs: build-artifacts
    steps:
      - name: Download Prometheus Artifacts
        uses: actions/download-artifact@v3
        with:
          name: prometheus-artifacts
      - name: Install nfpm
        run: |
          echo 'deb [trusted=yes] https://repo.goreleaser.com/apt/ /' | sudo tee /etc/apt/sources.list.d/goreleaser.list
          sudo apt update
          sudo apt install -y nfpm
      - name: Create Prometheus RPM Package
        run: nfpm package --config ../prometheus.yaml -p deb
        working-directory: _build/prometheus
